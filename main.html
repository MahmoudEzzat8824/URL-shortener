<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>URL Shortener</title>

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Simple loading spinner */
    .spinner {
      border: 4px solid rgba(0,0,0,.08);
      border-left-color: #4f46e5; /* Indigo */
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Small visuals for result/error */
    .hidden { display: none; }
  </style>

  <!-- Inline tiny favicon (data URI) to avoid CSP blocking of external /favicon.ico -->
  <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAGAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
</head>
<body class="bg-gray-100 font-sans antialiased">
  <div class="container mx-auto mt-16 p-4 max-w-2xl">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h1 class="text-3xl font-bold text-indigo-600 text-center mb-4">URL Shortener</h1>
      <p class="text-center text-gray-600 mb-6">Simple Flask + Redis URL shortener UI</p>

      <form id="shorten-form" class="grid grid-cols-1 gap-3">
        <label class="sr-only" for="long-url">Long URL</label>
        <input id="long-url" type="url" placeholder="https://mahmoudezzat8824.github.io/URL-shortener/" required
               class="p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"/>

        <label class="sr-only" for="custom-alias">Custom alias</label>
        <input id="custom-alias" type="text" placeholder="Custom alias (optional) â€” letters, numbers, - and _"
               class="p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"/>

        <div class="flex items-center gap-3">
          <button id="submit-button" type="submit"
                  class="flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <span id="button-text">Shorten</span>
            <span id="button-spinner" class="hidden spinner" aria-hidden="true"></span>
          </button>

          <button id="clear-button" type="button"
                  class="ml-auto text-sm text-gray-600 hover:underline focus:outline-none">Clear</button>
        </div>
      </form>

      <div id="result" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded hidden">
        <p class="text-sm text-gray-700 mb-2">Your shortened URL</p>
        <div class="flex gap-3 items-center">
          <input id="short-url-text" type="text" readonly class="flex-1 p-2 border border-gray-300 rounded font-mono text-indigo-700 bg-white"/>
          <button id="copy-button" class="bg-gray-700 text-white px-3 py-2 rounded hover:bg-gray-800">Copy</button>
          <a id="open-button" class="inline-block ml-2 text-sm text-indigo-600 hover:underline" target="_blank" rel="noopener">Open</a>
        </div>
      </div>

      <div id="error" class="mt-4 p-3 bg-red-50 text-red-800 border border-red-200 rounded hidden"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('shorten-form');
    const longUrlInput = document.getElementById('long-url');
    const customAliasInput = document.getElementById('custom-alias');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');
    const resultDiv = document.getElementById('result');
    const shortUrlText = document.getElementById('short-url-text');
    const copyButton = document.getElementById('copy-button');
    const openButton = document.getElementById('open-button');
    const errorDiv = document.getElementById('error');
    const clearButton = document.getElementById('clear-button');

    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.remove('hidden');
    }
    function clearError() {
      errorDiv.textContent = '';
      errorDiv.classList.add('hidden');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();
      resultDiv.classList.add('hidden');

      const longUrl = longUrlInput.value.trim();
      const customAlias = customAliasInput.value.trim();

      if (!longUrl) {
        showError('Please enter a URL.');
        return;
      }

      // UI: show spinner
      submitButton.disabled = true;
      buttonText.classList.add('hidden');
      buttonSpinner.classList.remove('hidden');

      try {
        const payload = { long_url: longUrl };
        if (customAlias) payload.custom_alias = customAlias;

        const res = await fetch('/api/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>({}));

        if (res.ok) {
          // server returns full short_url
          shortUrlText.value = data.short_url || '';
          openButton.href = data.short_url || '#';
          resultDiv.classList.remove('hidden');
          copyButton.textContent = 'Copy';
          // select short url for convenience
          shortUrlText.select();
        } else {
          // prefer server-provided error message
          const msg = (data && data.error) ? data.error : (`Request failed (${res.status})`);
          showError(msg);
        }
      } catch (err) {
        showError('Network error: ' + (err.message || err));
      } finally {
        submitButton.disabled = false;
        buttonText.classList.remove('hidden');
        buttonSpinner.classList.add('hidden');
      }
    });

    copyButton.addEventListener('click', async () => {
      const text = shortUrlText.value;
      if (!text) return;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          // legacy fallback
          shortUrlText.select();
          document.execCommand('copy');
        }
        copyButton.textContent = 'Copied!';
      } catch (err) {
        copyButton.textContent = 'Copy';
        alert('Failed to copy to clipboard, please copy manually.');
      }
    });

    clearButton.addEventListener('click', () => {
      longUrlInput.value = '';
      customAliasInput.value = '';
      shortUrlText.value = '';
      resultDiv.classList.add('hidden');
      clearError();
      copyButton.textContent = 'Copy';
    });

    // Optional: allow Enter to submit when focus on alias input
    customAliasInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        form.dispatchEvent(new Event('submit', { cancelable: true }));
      }
    });
  </script>
</body>
</html>